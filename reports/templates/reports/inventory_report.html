<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inventory Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    </style>
</head>
<body class="bg-light">

{% include 'reports/navbar.html' %}

<div class="toast-container"></div>

<div class="container mt-4">
  <h3 class="mb-3"><i class="bi bi-file-earmark-text"></i> Full Inventory Report</h3>

  <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
      <i class="bi bi-plus-circle"></i> Add Product
    </button>
    <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#addStockModal">
      <i class="bi bi-box-seam"></i> Add Stock
    </button>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSaleModal">
      <i class="bi bi-cart-plus"></i> Add Sale
    </button>
    <button id="downloadSelected" class="btn btn-success btn-sm" disabled>
      <i class="bi bi-download"></i> Download Selected
    </button>
    <button id="downloadAll" class="btn btn-outline-success btn-sm">
      <i class="bi bi-download"></i> Download All
    </button>
  </div>

  <div class="table-responsive shadow-sm">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-light">
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>Product #</th>
          <th>Item Name</th>
          <th>Sold</th>
          <th>Quantity</th>
          <th>Last Sales Date</th>
          <th>Excess</th>
          <th>Obsolete</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for p in page_obj %}
        <tr>
          <td><input type="checkbox" class="rowCheckbox" value="{{ p.product_num }}"></td>
          <td>{{ p.product_num }}</td>
          <td>{{ p.item_name }}</td>
          <td>{{ p.units_sold }}</td>
          <td>{{ p.quantity_on_hand }}</td>
          <td>{{ p.last_sales_date }}</td>
          <td>
            {% if p.is_excess %}
              <span class="badge bg-warning">Yes ({{ p.excess_qty }})</span>
            {% else %}
              <span class="badge bg-secondary">No</span>
            {% endif %}
          </td>
          <td>
            {% if p.is_obsolete %}
              <span class="badge bg-danger">Yes</span>
            {% else %}
              <span class="badge bg-secondary">No</span>
            {% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-warning me-1 edit-btn" title="Edit" data-product="{{ p.product_num }}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger delete-btn" title="Delete" data-product="{{ p.product_num }}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9" class="text-center">No inventory found</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-3">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% else %}
          <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addProductForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Product Number</label>
            <input type="text" class="form-control" name="product_num" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Item Name</label>
            <input type="text" class="form-control" name="item_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Initial Quantity</label>
            <input type="number" class="form-control" name="quantity" min="0" value="0" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitAddProduct()">Add Product</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Stock Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Stock to Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addStockForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Product Number</label>
            <input type="text" class="form-control" name="product_num" required list="productList">
            <datalist id="productList">
              {% for p in page_obj %}
              <option value="{{ p.product_num }}">{{ p.item_name }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity to Add</label>
            <input type="number" class="form-control" name="quantity" min="1" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info" onclick="submitAddStock()">Add Stock</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Sale Modal -->
<div class="modal fade" id="addSaleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Record New Sale</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addSaleForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Product Number</label>
            <input type="text" class="form-control" name="product_num" required list="productList2">
            <datalist id="productList2">
              {% for p in page_obj %}
              <option value="{{ p.product_num }}">{{ p.item_name }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div class="mb-3">
            <label class="form-label">Units Sold</label>
            <input type="number" class="form-control" name="units_sold" min="1" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Sale Date</label>
            <input type="date" class="form-control" name="sale_date" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitAddSale()">Record Sale</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editProductForm">
          {% csrf_token %}
          <input type="hidden" name="product_num" id="edit_product_num">
          <div class="mb-3">
            <label class="form-label">Item Name</label>
            <input type="text" class="form-control" name="item_name" id="edit_item_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity on Hand</label>
            <input type="number" class="form-control" name="quantity" id="edit_quantity" min="0" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="submitEditProduct()">Update Product</button>
      </div>
    </div>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function showToast(message, type = 'success') {
  const toastHTML = `
    <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  const container = document.querySelector('.toast-container');
  container.insertAdjacentHTML('beforeend', toastHTML);
  const toastEl = container.lastElementChild;
  const toast = new bootstrap.Toast(toastEl);
  toast.show();
  setTimeout(() => toastEl.remove(), 5000);
}

async function submitAddProduct() {
  const form = document.getElementById('addProductForm');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('/add-product/', {
      method: 'POST',
      body: formData,
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await response.json();
    
    if (data.success) {
      showToast(data.message, 'success');
      bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message, 'error');
    }
  } catch (error) {
    showToast('Error adding product', 'error');
  }
}

async function submitAddStock() {
  const form = document.getElementById('addStockForm');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('/add-stock/', {
      method: 'POST',
      body: formData,
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await response.json();
    
    if (data.success) {
      showToast(data.message, 'success');
      bootstrap.Modal.getInstance(document.getElementById('addStockModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message, 'error');
    }
  } catch (error) {
    showToast('Error adding stock', 'error');
  }
}

async function submitAddSale() {
  const form = document.getElementById('addSaleForm');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('/add-sale/', {
      method: 'POST',
      body: formData,
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await response.json();
    
    if (data.success) {
      showToast(data.message, 'success');
      bootstrap.Modal.getInstance(document.getElementById('addSaleModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message, 'error');
    }
  } catch (error) {
    showToast('Error recording sale', 'error');
  }
}

async function submitEditProduct() {
  const form = document.getElementById('editProductForm');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('/edit-product/', {
      method: 'POST',
      body: formData,
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await response.json();
    
    if (data.success) {
      showToast(data.message, 'success');
      bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message, 'error');
    }
  } catch (error) {
    showToast('Error updating product', 'error');
  }
}

document.addEventListener("DOMContentLoaded", function () {
  const selectAll = document.getElementById("selectAll");
  const checkboxes = document.querySelectorAll(".rowCheckbox");
  const downloadBtn = document.getElementById("downloadSelected");
  const downloadAllBtn = document.getElementById("downloadAll");

  function updateButtons() {
    const anyChecked = document.querySelectorAll(".rowCheckbox:checked").length > 0;
    downloadBtn.disabled = !anyChecked;
  }

  selectAll.addEventListener("change", () => {
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateButtons();
  });

  checkboxes.forEach(cb => cb.addEventListener("change", function() {
    if ([...checkboxes].every(c => c.checked)) {
      selectAll.checked = true;
      selectAll.indeterminate = false;
    } else if ([...checkboxes].some(c => c.checked)) {
      selectAll.checked = false;
      selectAll.indeterminate = true;
    } else {
      selectAll.checked = false;
      selectAll.indeterminate = false;
    }
    updateButtons();
  }));

  downloadBtn.addEventListener("click", function () {
    const selected = [];
    checkboxes.forEach((cb) => {
      if (cb.checked) selected.push(cb.value);
    });
    if (selected.length > 0) {
      window.location.href = '/download-csv/?products=' + selected.join(',');
    }
  });

  downloadAllBtn.addEventListener("click", function () {
    window.location.href = '/download-csv/';
  });

  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const productNum = this.dataset.product;
      try {
        const response = await fetch(`/get-product/${productNum}/`);
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('edit_product_num').value = data.product.product_num;
          document.getElementById('edit_item_name').value = data.product.item_name;
          document.getElementById('edit_quantity').value = data.product.quantity_on_hand;
          new bootstrap.Modal(document.getElementById('editProductModal')).show();
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        showToast('Error loading product data', 'error');
      }
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const productNum = this.dataset.product;
      
      if (confirm(`Are you sure you want to delete product ${productNum}?`)) {
        const formData = new FormData();
        formData.append('product_num', productNum);
        
        try {
          const response = await fetch('/delete-product/', {
            method: 'POST',
            body: formData,
            headers: {'X-CSRFToken': getCookie('csrftoken')}
          });
          const data = await response.json();
          
          if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast(data.message, 'error');
          }
        } catch (error) {
          showToast('Error deleting product', 'error');
        }
      }
    });
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>