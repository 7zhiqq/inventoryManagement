<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inventory Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    </style>
</head>
<body class="bg-light">

{% include 'reports/navbar.html' %}

<div class="toast-container"></div>

<div class="container">
  <h3 class="mb-4">Inventory Dashboard</h3>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-exclamation-triangle text-warning"></i> Excess Inventory</h5>
          <ul class="mb-0">
            {% for p in products %}
              {% if p.is_excess %}
              <li>{{ p.product_num }} - {{ p.item_name }}
                ({{ p.units_sold }} sold / {{ p.quantity_on_hand }} qty â†’ {{ p.excess_qty }} excess)
              </li>
              {% endif %}
            {% empty %}
              <li class="text-muted">No excess inventory</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-calendar-x text-danger"></i> Obsolete Inventory 
            <small class="text-muted">(Last Sold 10+ months ago)</small>
          </h5>
          <ul class="mb-0">
            {% for p in products %}
              {% if p.is_obsolete %}
              <li>{{ p.product_num }} - {{ p.item_name }} (Last Sale: {{ p.last_sales_date }})</li>
              {% endif %}
            {% empty %}
              <li class="text-muted">No obsolete inventory</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <h5 class="mb-3">Inventory Report</h5>

  <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
      <i class="bi bi-plus-circle"></i> Add Product
    </button>
    <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#addStockModal">
      <i class="bi bi-box-seam"></i> Add Stock
    </button>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSaleModal">
      <i class="bi bi-cart-plus"></i> Add Sale
    </button>
    <button id="downloadSelected" class="btn btn-success btn-sm" disabled>
      <i class="bi bi-download"></i> Download Selected
    </button>
  </div>

  <div class="table-responsive shadow-sm rounded">
    <table id="inventoryTable" class="table table-bordered table-hover align-middle text-center mb-0">
      <thead class="table-light">
        <tr>
          <th scope="col"><input type="checkbox" id="selectAll"></th>
          <th scope="col">Product #</th>
          <th scope="col">Item Name</th>
          <th scope="col">Sold</th>
          <th scope="col">Quantity</th>
          <th scope="col">Last Sales Date</th>
          <th scope="col">Excess</th>
          <th scope="col">Obsolete</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for p in products %}
        <tr data-product="{{ p.product_num }}">
          <td><input type="checkbox" class="row-check" value="{{ p.product_num }}"></td>
          <td>{{ p.product_num }}</td>
          <td>{{ p.item_name }}</td>
          <td>{{ p.units_sold }}</td>
          <td>{{ p.quantity_on_hand }}</td>
          <td>{{ p.last_sales_date }}</td>
          <td>{% if p.is_excess %}<span class="badge bg-warning">Yes ({{ p.excess_qty }})</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}</td>
          <td>{% if p.is_obsolete %}<span class="badge bg-danger">Yes</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}</td>
          <td>
            <button class="btn btn-sm btn-outline-warning me-1 edit-btn" title="Edit" data-product="{{ p.product_num }}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger delete-btn" title="Delete" data-product="{{ p.product_num }}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9" class="text-center">No inventory items found</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <small>Rows per page: 5</small>
    <nav><ul id="pagination" class="pagination pagination-sm mb-0"></ul></nav>
  </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addProductForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Product Number</label>
            <input type="text" class="form-control" name="product_num" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Item Name</label>
            <input type="text" class="form-control" name="item_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Initial Quantity</label>
            <input type="number" class="form-control" name="quantity" min="0" value="0" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitAddProduct()">Add Product</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Stock Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Stock to Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addStockForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Product Number</label>
            <input type="text" class="form-control" name="product_num" required list="productList">
            <datalist id="productList">
              {% for p in products %}
              <option value="{{ p.product_num }}">{{ p.item_name }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity to Add</label>
            <input type="number" class="form-control" name="quantity" min="1" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info" onclick="submitAddStock()">Add Stock</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Sale Modal -->
<div class="modal fade" id="addSaleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Record New Sale</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addSaleForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Product Number</label>
            <input type="text" class="form-control" name="product_num" required list="productList2">
            <datalist id="productList2">
              {% for p in products %}
              <option value="{{ p.product_num }}">{{ p.item_name }}</option>
              {% endfor %}
            </datalist>
          </div>
          <div class="mb-3">
            <label class="form-label">Units Sold</label>
            <input type="number" class="form-control" name="units_sold" min="1" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Sale Date</label>
            <input type="date" class="form-control" name="sale_date" value="{{ today }}" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitAddSale()">Record Sale</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editProductForm">
          {% csrf_token %}
          <input type="hidden" name="product_num" id="edit_product_num">
          <div class="mb-3">
            <label class="form-label">Item Name</label>
            <input type="text" class="form-control" name="item_name" id="edit_item_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity on Hand</label>
            <input type="number" class="form-control" name="quantity" id="edit_quantity" min="0" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="submitEditProduct()">Update Product</button>
      </div>
    </div>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function showToast(message, type = 'success') {
  const toastHTML = `
    <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  const container = document.querySelector('.toast-container');
  container.insertAdjacentHTML('beforeend', toastHTML);
  const toastEl = container.lastElementChild;
  const toast = new bootstrap.Toast(toastEl);
  toast.show();
  setTimeout(() => toastEl.remove(), 5000);
}

async function submitAddProduct() {
  const form = document.getElementById('addProductForm');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('/add-product/', {
      method: 'POST',
      body: formData,
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await response.json();
    
    if (data.success) {
      showToast(data.message, 'success');
      bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message, 'error');
    }
  } catch (error) {
    showToast('Error adding product', 'error');
  }
}

async function submitAddStock() {
  const form = document.getElementById('addStockForm');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('/add-stock/', {
      method: 'POST',
      body: formData,
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await response.json();
    
    if (data.success) {
      showToast(data.message, 'success');
      bootstrap.Modal.getInstance(document.getElementById('addStockModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message, 'error');
    }
  } catch (error) {
    showToast('Error adding stock', 'error');
  }
}

async function submitAddSale() {
  const form = document.getElementById('addSaleForm');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('/add-sale/', {
      method: 'POST',
      body: formData,
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await response.json();
    
    if (data.success) {
      showToast(data.message, 'success');
      bootstrap.Modal.getInstance(document.getElementById('addSaleModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message, 'error');
    }
  } catch (error) {
    showToast('Error recording sale', 'error');
  }
}

async function submitEditProduct() {
  const form = document.getElementById('editProductForm');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('/edit-product/', {
      method: 'POST',
      body: formData,
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await response.json();
    
    if (data.success) {
      showToast(data.message, 'success');
      bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast(data.message, 'error');
    }
  } catch (error) {
    showToast('Error updating product', 'error');
  }
}

document.addEventListener("DOMContentLoaded", function () {
  const rowsPerPage = 5;
  const table = document.getElementById("inventoryTable");
  const tbody = table.querySelector("tbody");
  const rows = tbody.querySelectorAll("tr");
  const pagination = document.getElementById("pagination");
  const pageCount = Math.ceil(rows.length / rowsPerPage);

  function showPage(page) {
    let start = (page - 1) * rowsPerPage;
    let end = start + rowsPerPage;
    rows.forEach((row, i) => {
      row.style.display = (i >= start && i < end) ? "" : "none";
    });
  }

  function setupPagination() {
    pagination.innerHTML = "";
    for (let i = 1; i <= pageCount; i++) {
      let li = document.createElement("li");
      li.className = "page-item";
      li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
      li.addEventListener("click", function (e) {
        e.preventDefault();
        document.querySelectorAll("#pagination .page-item").forEach(item => item.classList.remove("active"));
        li.classList.add("active");
        showPage(i);
      });
      pagination.appendChild(li);
    }
    if (pageCount > 0) pagination.firstChild.classList.add("active");
  }

  showPage(1);
  setupPagination();

  const selectAll = document.getElementById("selectAll");
  const rowChecks = document.querySelectorAll(".row-check");
  const downloadBtn = document.getElementById("downloadSelected");

  function updateDownloadButton() {
    const checkedRows = document.querySelectorAll(".row-check:checked");
    downloadBtn.disabled = checkedRows.length === 0;
  }

  selectAll.addEventListener("change", function () {
    rowChecks.forEach(cb => cb.checked = selectAll.checked);
    updateDownloadButton();
  });

  rowChecks.forEach(cb => {
    cb.addEventListener("change", function () {
      if ([...rowChecks].every(c => c.checked)) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else if ([...rowChecks].some(c => c.checked)) {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      }
      updateDownloadButton();
    });
  });

  downloadBtn.addEventListener("click", function () {
    const selected = [];
    rowChecks.forEach((cb) => {
      if (cb.checked) selected.push(cb.value);
    });
    if (selected.length > 0) {
      window.location.href = '/download-csv/?products=' + selected.join(',');
    }
  });

  // Edit button handler
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const productNum = this.dataset.product;
      try {
        const response = await fetch(`/get-product/${productNum}/`);
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('edit_product_num').value = data.product.product_num;
          document.getElementById('edit_item_name').value = data.product.item_name;
          document.getElementById('edit_quantity').value = data.product.quantity_on_hand;
          new bootstrap.Modal(document.getElementById('editProductModal')).show();
        } else {
          showToast(data.message, 'error');
        }
      } catch (error) {
        showToast('Error loading product data', 'error');
      }
    });
  });

  // Delete button handler
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const productNum = this.dataset.product;
      
      if (confirm(`Are you sure you want to delete product ${productNum}?`)) {
        const formData = new FormData();
        formData.append('product_num', productNum);
        
        try {
          const response = await fetch('/delete-product/', {
            method: 'POST',
            body: formData,
            headers: {'X-CSRFToken': getCookie('csrftoken')}
          });
          const data = await response.json();
          
          if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast(data.message, 'error');
          }
        } catch (error) {
          showToast('Error deleting product', 'error');
        }
      }
    });
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>